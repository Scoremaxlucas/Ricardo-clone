generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model User {
  id                            String               @id @default(cuid())
  email                         String               @unique
  name                          String?
  title                         String?
  firstName                     String?
  lastName                      String?
  password                      String?
  image                         String?
  createdAt                     DateTime             @default(now())
  updatedAt                     DateTime             @updatedAt
  emailVerified                 Boolean              @default(false)
  emailVerifiedAt               DateTime?
  emailVerificationToken        String?
  emailVerificationTokenExpires DateTime?
  nickname                      String?
  bio                           String?
  specialization                String?
  profileComplete               Boolean              @default(false)
  dateOfBirth                   DateTime?
  nationality                   String?
  phone                         String?
  phoneVerified                 Boolean              @default(false)
  street                        String?
  streetNumber                  String?
  postalCode                    String?
  city                          String?
  country                       String?
  billingStreet                 String?
  billingStreetNumber           String?
  billingPostalCode             String?
  billingCity                   String?
  billingCountry                String?
  deliveryStreet                String?
  deliveryStreetNumber          String?
  deliveryPostalCode            String?
  deliveryCity                  String?
  deliveryCountry               String?
  paymentMethods                String?
  idDocument                    String?
  idDocumentPage1               String?
  idDocumentPage2               String?
  idDocumentType                String?
  companyName                   String?
  accountType                   String?
  verified                      Boolean              @default(false)
  verificationLevel             String?
  verifiedAt                    DateTime?
  verificationStatus            String?              @default("pending")
  verificationReviewedAt        DateTime?
  verificationReviewedBy        String?
  isAdmin                       Boolean              @default(false)
  isBlocked                     Boolean              @default(false)
  blockedAt                     DateTime?
  blockedBy                     String?
  blockedReason                 String?
  warningCount                  Int                  @default(0)
  lastWarnedAt                  DateTime?
  hasUnpaidInvoices             Boolean              @default(false)
  lastInvoiceReminderAt         DateTime?
  accounts                      Account[]
  bids                          Bid[]
  favorites                     Favorite[]
  invoices                      Invoice[]
  receivedMessages              Message[]            @relation("MessageReceiver")
  messages                      Message[]            @relation("MessageSender")
  notifications                 Notification[]
  priceOffers                   PriceOffer[]
  purchases                     Purchase[]
  receivedReviews               Review[]             @relation("ReviewedUser")
  reviews                       Review[]
  salePurchases                 Sale[]               @relation("SaleBuyer")
  sales                         Sale[]
  searchSubscriptions           SearchSubscription[]
  sessions                      Session[]
  watches                       Watch[]
  conversations                 Conversation[]
  reportsMade                   Report[]             @relation("ReportedBy")
  reportsReviewed               Report[]             @relation("ReviewedBy")
  adminNotes                    AdminNote[]
  moderationHistory             ModerationHistory[]

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Watch {
  id                  String              @id @default(cuid())
  articleNumber       Int?                @unique
  title               String
  description         String?
  brand               String
  model               String
  year                Int?
  condition           String
  material            String?
  movement            String?
  caseSize            Float?
  caseDiameter        Float?
  price               Float
  buyNowPrice         Float?
  isAuction           Boolean             @default(false)
  auctionStart        DateTime?
  auctionEnd          DateTime?
  auctionDuration     Int?
  autoRenew           Boolean             @default(false)
  lastBidAt           DateTime?
  images              String
  video               String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  lastRevision        DateTime?
  accuracy            String?
  fullset             Boolean             @default(false)
  allLinks            Boolean             @default(false)
  box                 Boolean             @default(false)
  papers              Boolean             @default(false)
  warranty            String?
  warrantyMonths      Int?
  warrantyYears       Int?
  warrantyNote        String?
  warrantyDescription String?
  referenceNumber     String?
  shippingMethod      String?
  boosters            String?
  sellerId            String
  moderationStatus   String?              @default("pending") // 'pending', 'approved', 'rejected', 'reviewing'
  moderatedBy         String?
  moderatedAt         DateTime?
  moderationNotes     String?
  bids                Bid[]
  favorites           Favorite[]
  invoiceItems        InvoiceItem[]
  messages            Message[]
  priceOffers         PriceOffer[]
  purchases           Purchase[]
  sales               Sale[]
  categories          WatchCategory[]
  seller              User                @relation(fields: [sellerId], references: [id])
  reports             Report[]
  adminNotes          AdminNote[]
  moderationHistory   ModerationHistory[]
  views               WatchView[]

  @@index([moderationStatus])
  @@index([createdAt])
  @@map("watches")
}

model Bid {
  id        String   @id @default(cuid())
  amount    Float
  createdAt DateTime @default(now())
  watchId   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  watch     Watch    @relation(fields: [watchId], references: [id])

  @@map("bids")
}

model Purchase {
  id                             String       @id @default(cuid())
  price                          Float?
  shippingMethod                 String?
  status                         String       @default("pending")
  itemReceived                   Boolean      @default(false)
  itemReceivedAt                 DateTime?
  paymentConfirmed               Boolean      @default(false)
  paymentConfirmedAt             DateTime?
  contactDeadline                DateTime
  sellerContactedAt              DateTime?
  buyerContactedAt               DateTime?
  contactWarningSentAt           DateTime?
  contactDeadlineMissed          Boolean      @default(false)
  paymentDeadline                DateTime?
  paymentReminderSentAt          DateTime?
  paymentDeadlineMissed          Boolean      @default(false)
  trackingNumber                 String?
  trackingProvider               String?
  shippedAt                      DateTime?
  estimatedDeliveryDate          DateTime?
  disputeOpenedAt                DateTime?
  disputeReason                  String?
  disputeDescription             String?
  disputeStatus                  String?
  disputeResolvedAt              DateTime?
  disputeResolvedBy              String?
  cancellationRequestedAt        DateTime?
  cancellationRequestStatus      String?
  cancellationRequestReason      String?
  cancellationRequestDescription String?
  cancellationRequestResolvedAt  DateTime?
  cancellationRequestResolvedBy  String?
  statusHistory                  String?
  paid                           Boolean      @default(false)
  paidAt                         DateTime?
  createdAt                      DateTime     @default(now())
  updatedAt                      DateTime     @updatedAt
  watchId                        String
  buyerId                        String
  priceOffers                    PriceOffer[]
  buyer                          User         @relation(fields: [buyerId], references: [id])
  watch                          Watch        @relation(fields: [watchId], references: [id])
  reviews                        Review[]

  @@map("purchases")
}

model Sale {
  id        String   @id @default(cuid())
  price     Float?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  watchId   String
  sellerId  String
  buyerId   String?
  reviews   Review[]
  buyer     User?    @relation("SaleBuyer", fields: [buyerId], references: [id])
  seller    User     @relation(fields: [sellerId], references: [id])
  watch     Watch    @relation(fields: [watchId], references: [id])

  @@map("sales")
}

model Payment {
  id        String   @id @default(cuid())
  amount    Float
  status    String
  createdAt DateTime @default(now())

  @@map("payments")
}

model Review {
  id             String    @id @default(cuid())
  rating         String
  comment        String?
  createdAt      DateTime  @default(now())
  reviewerId     String
  reviewedUserId String
  purchaseId     String?
  saleId         String?
  sale           Sale?     @relation(fields: [saleId], references: [id])
  purchase       Purchase? @relation(fields: [purchaseId], references: [id])
  reviewedUser   User      @relation("ReviewedUser", fields: [reviewedUserId], references: [id])
  reviewer       User      @relation(fields: [reviewerId], references: [id])

  @@unique([purchaseId, reviewerId])
  @@unique([saleId, reviewerId])
  @@map("reviews")
}

model Favorite {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  watchId   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  watch     Watch    @relation(fields: [watchId], references: [id])

  @@unique([watchId, userId])
  @@map("favorites")
}

model Category {
  id        String          @id @default(cuid())
  name      String          @unique
  slug      String          @unique
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  watches   WatchCategory[]

  @@map("categories")
}

model WatchCategory {
  id         String   @id @default(cuid())
  watchId    String
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])
  watch      Watch    @relation(fields: [watchId], references: [id])

  @@unique([watchId, categoryId])
  @@map("watch_categories")
}

model Message {
  id         String   @id @default(cuid())
  content    String
  createdAt  DateTime @default(now())
  read       Boolean  @default(false)
  isPublic   Boolean  @default(false)
  watchId    String
  senderId   String
  receiverId String
  receiver   User     @relation("MessageReceiver", fields: [receiverId], references: [id])
  sender     User     @relation("MessageSender", fields: [senderId], references: [id])
  watch      Watch    @relation(fields: [watchId], references: [id])

  @@map("messages")
}

model Invoice {
  id                   String        @id @default(cuid())
  invoiceNumber        String        @unique
  sellerId             String
  saleId               String?
  subtotal             Float
  vatRate              Float         @default(0.081)
  vatAmount            Float
  total                Float
  status               String        @default("pending")
  paidAt               DateTime?
  dueDate              DateTime
  paymentMethod        String?
  paymentReference     String?
  paymentConfirmedAt   DateTime?
  qrCode               String?
  paymentRequestSentAt DateTime?
  firstReminderSentAt  DateTime?
  secondReminderSentAt DateTime?
  finalReminderSentAt  DateTime?
  reminderCount        Int           @default(0)
  lateFeeAdded         Boolean       @default(false)
  lateFeeAmount        Float         @default(0)
  accountBlockedAt     DateTime?
  accountBlockedReason String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  refundedAt           DateTime?
  items                InvoiceItem[]
  seller               User          @relation(fields: [sellerId], references: [id])

  @@map("invoices")
}

model InvoiceItem {
  id          String   @id @default(cuid())
  invoiceId   String
  watchId     String?
  description String
  quantity    Int      @default(1)
  price       Float
  total       Float
  createdAt   DateTime @default(now())
  watch       Watch?   @relation(fields: [watchId], references: [id])
  invoice     Invoice  @relation(fields: [invoiceId], references: [id])

  @@map("invoice_items")
}

model BoosterPrice {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?
  price       Float
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("booster_prices")
}

model PriceOffer {
  id         String    @id @default(cuid())
  amount     Float
  message    String?
  status     String    @default("pending")
  expiresAt  DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  watchId    String
  buyerId    String
  purchaseId String?
  purchase   Purchase? @relation(fields: [purchaseId], references: [id])
  buyer      User      @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  watch      Watch     @relation(fields: [watchId], references: [id], onDelete: Cascade)

  @@map("price_offers")
}

model Notification {
  id           String    @id @default(cuid())
  type         String
  title        String
  message      String
  link         String?
  isRead       Boolean   @default(false)
  readAt       DateTime?
  createdAt    DateTime  @default(now())
  userId       String
  watchId      String?
  bidId        String?
  questionId   String?
  priceOfferId String?
  purchaseId   String?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

model SearchSubscription {
  id            String    @id @default(cuid())
  userId        String
  searchTerm    String?
  brand         String?
  model         String?
  categoryId    String?
  subcategoryId String?
  minPrice      Float?
  maxPrice      Float?
  condition     String?
  yearFrom      Int?
  yearTo        Int?
  isActive      Boolean   @default(true)
  matchesFound  Int       @default(0)
  lastMatchAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isActive])
  @@index([isActive])
  @@map("search_subscriptions")
}

model Conversation {
  id        String                @id @default(cuid())
  userId    String?
  context   String? // JSON string mit Kontext (productId, etc.)
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  messages  ConversationMessage[]
  user      User?                 @relation(fields: [userId], references: [id])

  @@map("conversations")
}

model ConversationMessage {
  id             String       @id @default(cuid())
  conversationId String
  role           String // 'user' | 'assistant' | 'system'
  content        String
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("conversation_messages")
}

model ContactRequest {
  id         String    @id @default(cuid())
  category   String // 'technical', 'account', 'payment', 'safety', 'general', 'feedback', 'other'
  email      String
  subject    String
  message    String
  status     String    @default("pending") // 'pending', 'in_progress', 'resolved', 'closed'
  resolvedAt DateTime?
  resolvedBy String?
  notes      String? // Admin-Notizen
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@map("contact_requests")
}

// Melde-System für Angebote
model Report {
  id          String    @id @default(cuid())
  watchId     String
  reportedBy  String // User-ID des Meldenden
  reason      String // 'spam', 'fraud', 'wrong_category', 'inappropriate', 'duplicate', 'other'
  description String? // Zusätzliche Beschreibung
  status      String    @default("pending") // 'pending', 'reviewing', 'resolved', 'dismissed'
  reviewedBy  String? // Admin-ID
  reviewedAt  DateTime?
  resolution  String? // Was wurde gemacht
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  watch       Watch     @relation(fields: [watchId], references: [id], onDelete: Cascade)
  reporter    User      @relation("ReportedBy", fields: [reportedBy], references: [id])
  reviewer    User?     @relation("ReviewedBy", fields: [reviewedBy], references: [id])

  @@index([watchId])
  @@index([status])
  @@index([createdAt])
  @@map("reports")
}

// Admin-Notizen zu Angeboten
model AdminNote {
  id        String   @id @default(cuid())
  watchId   String
  adminId   String // Admin-ID
  note      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  watch     Watch    @relation(fields: [watchId], references: [id], onDelete: Cascade)
  admin     User     @relation(fields: [adminId], references: [id])

  @@index([watchId])
  @@index([createdAt])
  @@map("admin_notes")
}

// Moderation-Historie
model ModerationHistory {
  id        String   @id @default(cuid())
  watchId   String
  adminId   String // Admin-ID
  action    String // 'activated', 'deactivated', 'deleted', 'edited', 'reported', 'note_added'
  details   String? // JSON mit Details
  createdAt DateTime @default(now())
  watch     Watch    @relation(fields: [watchId], references: [id], onDelete: Cascade)
  admin     User     @relation(fields: [adminId], references: [id])

  @@index([watchId])
  @@index([createdAt])
  @@map("moderation_history")
}

// Aufrufe-Tracking für Statistiken
model WatchView {
  id        String   @id @default(cuid())
  watchId   String
  userId    String? // Optional, falls angemeldet
  ipAddress String?
  userAgent String?
  viewedAt  DateTime @default(now())
  watch     Watch    @relation(fields: [watchId], references: [id], onDelete: Cascade)

  @@index([watchId])
  @@index([viewedAt])
  @@map("watch_views")
}
